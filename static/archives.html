<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Alex Todo Dashboard ¬∑ Archives</title>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet" />
    <!-- Inline theme initialization -->
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = savedTheme || (prefersDark ? 'dark' : 'light');
            document.documentElement.setAttribute('data-theme', theme);
            if (theme === 'dark') document.documentElement.classList.add('dark');
        })();
    </script>
    <!-- iOS-like Design System FIRST -->
    <link href="/styles/design-system.css" rel="stylesheet" />
    <link href="/theme.css" rel="stylesheet" />
    <link href="/styles/components.css" rel="stylesheet" />
    <link href="/styles/utilities.css" rel="stylesheet" />
    <link href="/styles/animations.css" rel="stylesheet" />
    <!-- Tailwind LAST with disabled preflight -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <script>
        tailwind.config = {
            corePlugins: {
                preflight: false,
            },
            darkMode: ['class', '[data-theme="dark"]'],
            theme: {
                extend: {
                    colors: {
                        base: '#f5f5f7',
                        surface: '#ffffff',
                        'surface-2': '#fafafa',
                        'surface-3': '#ffffff',
                        accent: '#3b82f6',
                        secondary: '#3b82f6',
                        muted: '#86868b',
                        faint: '#aeaeb2',
                        border: 'rgba(0, 0, 0, 0.1)',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444',
                        info: '#3b82f6',
                    }
                }
            }
        }
    </script>
</head>

<body class="font-sans min-h-screen relative overflow-x-hidden" style="background-color: var(--bg-base); color: var(--text-primary);">
    <!-- Background effects - Subtle blue gradients -->
    <div class="fixed inset-0 z-0 pointer-events-none">
        <div class="absolute top-[-10%] right-[-10%] w-[40%] h-[40%] rounded-full opacity-[0.03] blur-[120px]" style="background: var(--primary);"></div>
        <div class="absolute bottom-[10%] left-[-5%] w-[35%] h-[35%] rounded-full opacity-[0.02] blur-[100px]" style="background: var(--primary);"></div>
    </div>

    <div class="relative z-10 max-w-6xl mx-auto p-6 space-y-10">
        <header
            class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 pb-8" style="border-bottom: 1px solid var(--border-subtle);">
            <div>
                <div class="flex items-center gap-4">
                    <div
                        class="w-12 h-12 rounded-xl flex items-center justify-center text-2xl" style="background: var(--gradient-primary);">
                        üì¶
                    </div>
                    <div>
                        <h1
                            class="text-3xl md:text-4xl font-display font-bold tracking-tight" style="color: var(--primary);">
                            Archives
                        </h1>
                        <p class="text-sm mt-1 font-medium" style="color: var(--text-muted);">Historique des t√¢ches termin√©es</p>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <!-- Theme Toggle -->
                <button type="button" id="themeToggle" class="btn btn-icon" aria-label="Changer le th√®me" title="Changer le th√®me">
                    <span class="material-icons-round theme-icon" data-theme-icon="light">dark_mode</span>
                    <span class="material-icons-round theme-icon" data-theme-icon="dark">light_mode</span>
                </button>
                <nav class="flex flex-wrap gap-3 items-center" aria-label="Navigation principale" role="navigation">
                    <a class="nav-link" href="/">Dashboard</a>
                    <a class="nav-link" href="/projects">Projets</a>
                    <a class="nav-link" href="/dca">DCA</a>
                    <a class="nav-link active" href="/archives" aria-current="page">Archives</a>
                </nav>
            </div>
        </header>

        <section class="glass-panel rounded-xl p-6 reveal" style="--delay: 0.15s;">
            <div class="flex flex-col md:flex-row md:items-center gap-4 mb-6">
                <div class="flex-1">
                    <label class="label" for="searchInput">Recherche</label>
                    <input id="searchInput" type="text" placeholder="Filtrer par titre..." class="field" />
                </div>
                <div class="md:w-56">
                    <label class="label" for="categoryFilter">Cat√©gorie</label>
                    <select id="categoryFilter" class="field">
                        <option value="all">Toutes</option>
                        <option value="easynode">üöÄ EasyNode</option>
                        <option value="immobilier">üèØ Immobilier</option>
                        <option value="content">üì± Content</option>
                        <option value="personnel">üéã Personnel</option>
                        <option value="admin">üìÑ Admin</option>
                    </select>
                </div>
            </div>

            <div class="space-y-3" id="archiveList">
                <div class="text-center py-12 text-faint">
                    <span class="text-4xl mb-3 block">‚è≥</span>
                    <p class="text-sm">Chargement des archives...</p>
                </div>
            </div>
        </section>
    </div>

    <!-- Theme Switcher -->
    <script src="/js/theme-switcher.js"></script>

    <script>
        let archivedTodos = [];
        let currentFilter = { category: 'all', query: '' };

        document.addEventListener('DOMContentLoaded', () => {
            loadArchivedTodos();
            document.getElementById('searchInput').addEventListener('input', (e) => {
                currentFilter.query = e.target.value.toLowerCase();
                renderArchives();
            });
            document.getElementById('categoryFilter').addEventListener('change', (e) => {
                currentFilter.category = e.target.value;
                renderArchives();
            });
        });

        async function loadArchivedTodos() {
            try {
                const response = await fetch('/api/todos/archived');
                archivedTodos = await response.json();
                renderArchives();
            } catch (error) {
                console.error('Error loading archives:', error);
            }
        }

        function renderArchives() {
            const list = document.getElementById('archiveList');
            let filtered = [...archivedTodos];

            if (currentFilter.category !== 'all') {
                filtered = filtered.filter(todo => todo.category === currentFilter.category);
            }
            if (currentFilter.query) {
                filtered = filtered.filter(todo => todo.title.toLowerCase().includes(currentFilter.query));
            }

            if (filtered.length === 0) {
                list.innerHTML = `
                    <div class="text-center py-12 text-faint">
                        <span class="text-4xl mb-3 block">üì¶</span>
                        <p class="text-sm">Aucune t√¢che archiv√©e pour le moment.</p>
                    </div>`;
                return;
            }

            list.innerHTML = filtered.map(todo => {
                const priorityClass = `priority-${todo.priority}`;
                const categoryEmoji = {
                    'easynode': 'üöÄ',
                    'immobilier': 'üèØ',
                    'content': 'üì±',
                    'personnel': 'üéã',
                    'admin': 'üìÑ'
                }[todo.category] || 'üìã';

                const deadlineStr = todo.deadline
                    ? new Date(todo.deadline).toLocaleDateString('fr-FR', {
                        day: 'numeric',
                        month: 'short',
                        hour: '2-digit',
                        minute: '2-digit'
                    })
                    : null;

                return `
                    <div class="todo-item">
                        <div class="todo-content flex-1">
                            <div class="todo-title">${todo.title}</div>
                            ${todo.description ? `<div class="todo-description">${todo.description}</div>` : ''}
                            <div class="todo-meta">
                                <span>${categoryEmoji} ${todo.category}</span>
                                ${deadlineStr ? `<span>‚è≥ ${deadlineStr}</span>` : ''}
                                <span>üì¶ Archiv√©e</span>
                            </div>
                        </div>
                        <span class="priority-badge ${priorityClass}">${todo.priority}</span>
                        <div class="flex items-center gap-2">
                            <button class="action-btn" onclick="restoreTodo(${todo.id})" title="Restaurer">
                                <span class="material-icons-round text-sm">restart_alt</span>
                            </button>
                            <button class="action-btn delete" onclick="deleteTodo(${todo.id})" title="Supprimer">
                                <span class="material-icons-round text-sm">delete</span>
                            </button>
                        </div>
                    </div>`;
            }).join('');
        }

        async function restoreTodo(id) {
            if (!confirm('Restaurer cette t√¢che ?')) return;
            try {
                await fetch(`/api/todos/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ archived: 0, status: 'pending' })
                });
                archivedTodos = archivedTodos.filter(t => t.id !== id);
                renderArchives();
            } catch (error) {
                console.error('Error restoring todo:', error);
            }
        }

        async function deleteTodo(id) {
            if (!confirm('Supprimer cette t√¢che d√©finitivement ?')) return;
            try {
                await fetch(`/api/todos/${id}`, { method: 'DELETE' });
                archivedTodos = archivedTodos.filter(t => t.id !== id);
                renderArchives();
            } catch (error) {
                console.error('Error deleting todo:', error);
            }
        }
    </script>
</body>

</html>