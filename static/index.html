<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Alex Dashboard</title>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <script>
        tailwind.config = {
            darkMode: ['class', '[data-theme="dark"]'],
            theme: {
                extend: {
                    colors: {
                        base: '#f5f5f7',
                        surface: '#ffffff',
                        'surface-2': '#fafafa',
                        'surface-3': '#ffffff',
                        accent: '#3b82f6',
                        secondary: '#3b82f6',
                        muted: '#86868b',
                        faint: '#aeaeb2',
                        border: 'rgba(0, 0, 0, 0.1)',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444',
                        info: '#3b82f6',
                    }
                }
            }
        }
    </script>
    <!-- Inline theme initialization to prevent flash -->
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = savedTheme || (prefersDark ? 'dark' : 'light');
            document.documentElement.setAttribute('data-theme', theme);
            if (theme === 'dark') document.documentElement.classList.add('dark');
        })();
    </script>
    <!-- Legacy theme first, then design system to override -->
    <link href="/theme.css" rel="stylesheet" />
    <!-- iOS-like Design System -->
    <link href="/styles/design-system.css" rel="stylesheet" />
    <link href="/styles/components.css" rel="stylesheet" />
    <link href="/styles/utilities.css" rel="stylesheet" />
    <link href="/styles/animations.css" rel="stylesheet" />
</head>

<body class="font-sans min-h-screen relative overflow-x-hidden" style="background-color: var(--bg-base); color: var(--text-primary);">
    <!-- Background effects - Subtle blue gradients -->
    <div class="fixed inset-0 z-0 pointer-events-none">
        <div class="absolute top-[-10%] right-[-10%] w-[40%] h-[40%] rounded-full opacity-[0.03] blur-[120px]" style="background: var(--primary);"></div>
        <div class="absolute bottom-[10%] left-[-5%] w-[35%] h-[35%] rounded-full opacity-[0.02] blur-[100px]" style="background: var(--primary);"></div>
    </div>

    <div class="relative z-10 max-w-7xl mx-auto p-4 md:p-8 space-y-8" id="top">
        <header
            class="flex flex-col md:flex-row justify-between items-start md:items-center pb-6 gap-4" style="border-bottom: 1px solid var(--border-subtle);">
            <div>
                <div class="flex items-center gap-3">
                    <div
                        class="w-11 h-11 rounded-xl flex items-center justify-center text-xl" style="background: var(--gradient-primary);">
                        ‚ö°
                    </div>
                    <div>
                        <h1 class="text-2xl md:text-3xl font-semibold tracking-tight" style="color: var(--text-primary);">
                            Alex <span style="color: var(--primary);">Dashboard</span>
                        </h1>
                        <p class="text-sm mt-0.5" id="currentDate" style="color: var(--text-muted);">Chargement...</p>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <!-- Theme Toggle -->
                <button type="button" id="themeToggle" class="btn btn-icon" aria-label="Changer le th√®me" title="Changer le th√®me">
                    <span class="material-icons-round theme-icon" data-theme-icon="light">dark_mode</span>
                    <span class="material-icons-round theme-icon" data-theme-icon="dark">light_mode</span>
                </button>
                <button type="button" class="btn btn-secondary" onclick="sendDailySummary()">
                    <span class="material-icons-round text-base text-accent">send</span>
                    R√©sum√©
                </button>
                <button type="button" class="btn btn-primary" onclick="openModal()">
                    <span class="material-icons-round text-base">add</span>
                    Nouvelle t√¢che

                </button>
            </div>
        </header>
        <nav class="flex flex-wrap gap-3 items-center reveal" style="--delay: 0.1s;" aria-label="Navigation principale" role="navigation">
            <a class="nav-link active" href="/" aria-current="page">Dashboard</a>
            <a class="nav-link" href="/projects">Projets</a>
            <a class="nav-link" href="/dca">DCA</a>
            <a class="nav-link" href="/archives">Archives</a>
        </nav>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 reveal" style="--delay: 0.15s;"
            id="section-stats">
            <div
                class="glass-panel p-5 rounded-xl flex flex-col justify-between hover:translate-y-[-2px] transition-transform duration-300 group cursor-default">
                <h3 class="text-xs font-bold tracking-widest uppercase mb-2" style="color: var(--text-muted);">Total T√¢ches</h3>
                <div class="flex items-end justify-between">
                    <span class="text-4xl font-display font-light" id="statTotal" style="color: var(--text-primary);">0</span>
                    <span
                        class="material-icons-round text-4xl opacity-30 group-hover:opacity-60 transition-opacity" style="color: var(--primary);">list_alt</span>
                </div>
            </div>
            <div
                class="glass-panel p-5 rounded-xl flex flex-col justify-between hover:translate-y-[-2px] transition-transform duration-300 group cursor-default">
                <h3 class="text-xs font-bold tracking-widest text-muted uppercase mb-2">En Attente</h3>
                <div class="flex items-end justify-between">
                    <span class="text-4xl font-display font-light text-warning" id="statPending">0</span>
                    <span
                        class="material-icons-round text-warning text-4xl opacity-30 group-hover:opacity-60 transition-opacity">hourglass_empty</span>
                </div>
            </div>
            <div
                class="glass-panel p-5 rounded-xl flex flex-col justify-between hover:translate-y-[-2px] transition-transform duration-300 group cursor-default">
                <h3 class="text-xs font-bold tracking-widest text-muted uppercase mb-2">Compl√©t√©es</h3>
                <div class="flex items-end justify-between">
                    <span class="text-4xl font-display font-light text-success" id="statCompleted">0</span>
                    <span
                        class="material-icons-round text-success text-4xl opacity-30 group-hover:opacity-60 transition-opacity">check_circle</span>
                </div>
            </div>
            <div
                class="glass-panel p-5 rounded-xl flex flex-col justify-between hover:translate-y-[-2px] transition-transform duration-300 group cursor-default">
                <h3 class="text-xs font-bold tracking-widest text-muted uppercase mb-2">En Retard</h3>
                <div class="flex items-end justify-between">
                    <span class="text-4xl font-display font-light text-danger" id="statOverdue">0</span>
                    <span
                        class="material-icons-round text-danger text-4xl opacity-30 group-hover:opacity-60 transition-opacity">warning</span>
                </div>
            </div>
            <div
                class="glass-panel p-5 rounded-xl flex flex-col justify-between hover:translate-y-[-2px] transition-transform duration-300 group cursor-default">
                <h3 class="text-xs font-bold tracking-widest text-muted uppercase mb-2">
                    Aujourd'hui</h3>
                <div class="flex items-end justify-between">
                    <span class="text-4xl font-display font-light text-ink" id="statToday">0</span>
                    <span
                        class="material-icons-round text-info text-4xl opacity-30 group-hover:opacity-60 transition-opacity">today</span>
                </div>
            </div>
        </div>
        <div class="glass-panel p-6 rounded-xl reveal" style="--delay: 0.2s;" id="section-progress">
            <div class="flex justify-between items-center mb-3">
                <span class="text-sm font-medium text-subtle">Progression globale</span>
                <span class="text-sm font-bold text-accent" id="progressPercent">0%</span>
            </div>
            <div class="progress-track">
                <div class="progress-fill w-0" id="progressFill" style="width: 0%"></div>
            </div>
        </div>

        <!-- Citation & Fait du jour -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 reveal" id="section-daily">
            <div class="glass-panel p-6 border-l-4 border-accent">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xs font-bold tracking-widest text-accent uppercase">Citation du jour</h3>
                    <button type="button" class="text-muted hover:text-accent transition-colors"
                        onclick="refreshDailyContent()">
                        <span class="material-icons-round text-lg">refresh</span>
                    </button>
                </div>
                <blockquote class="text-lg font-medium leading-relaxed italic mb-3" id="dailyQuote">
                    "Chargement..."
                </blockquote>
                <p class="text-sm text-muted font-medium" id="dailyQuoteAuthor">‚Äî ...</p>
            </div>
            <div class="glass-panel p-6 border-l-4 border-secondary">
                <h3 class="text-xs font-bold tracking-widest text-secondary uppercase mb-4">Le saviez-vous ?</h3>
                <p class="text-sm text-secondary-contrast leading-relaxed" id="dailyFunFact">Chargement...</p>
            </div>
        </div>

        <!-- Roadmap Section -->
        <div class="glass-panel rounded-xl reveal" style="--delay: 0.3s;" id="section-roadmap">
            <div
                class="p-6 border-b border-subtle flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div class="flex items-center gap-3">
                    <span class="text-2xl">üó∫Ô∏è</span>
                    <h2 class="text-xl font-display font-medium text-ink">Roadmap</h2>
                </div>
                <div class="flex items-center gap-3">
                    <div class="flex p-1 bg-surface-2 rounded-lg border border-subtle">
                        <button type="button"
                            class="roadmap-tab px-4 py-1.5 rounded-md text-xs font-medium transition-all active"
                            data-type="mid_term">Mi-terme (3-6 mois)</button>
                        <button type="button"
                            class="roadmap-tab px-4 py-1.5 rounded-md text-xs font-medium transition-all"
                            data-type="long_term">Long-terme (6+ mois)</button>
                    </div>
                    <button type="button" class="btn btn-primary btn-sm" onclick="openRoadmapModal()">
                        <span class="material-icons-round text-base">add</span>
                        Objectif
                    </button>
                </div>
            </div>
            <div class="p-6 min-h-[200px]" id="roadmapContent">
                <div class="flex flex-col items-center justify-center h-40 text-center">
                    <span class="text-4xl mb-3 animate-pulse">üéØ</span>
                    <p class="text-sm text-muted">Aucun objectif d√©fini. Ajoutez votre premier objectif!</p>
                </div>
            </div>
        </div>

        <!-- Analytics & Habits Row -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 reveal" style="--delay: 0.35s;" id="section-analytics">
            <!-- Graphique Productivit√© -->
            <div class="glass-panel rounded-xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <span class="text-2xl">üìä</span>
                        <h3 class="text-sm font-bold tracking-widest text-subtle uppercase">Productivit√©</h3>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-xs text-success font-semibold" id="streakBadge">üî• 0 jours</span>
                    </div>
                </div>
                <div class="relative h-48 w-full">
                    <canvas id="productivityChart"></canvas>
                </div>
                <div class="flex justify-between mt-4 text-xs text-muted">
                    <span>Meilleur jour: <strong id="bestDayLabel">-</strong></span>
                    <span>Cette semaine: <strong id="weeklyTotal">0</strong> t√¢ches</span>
                </div>
            </div>

            <!-- Habitudes Tracker -->
            <div class="glass-panel rounded-xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <span class="text-2xl">‚úÖ</span>
                        <h3 class="text-sm font-bold tracking-widest text-subtle uppercase">Habitudes</h3>
                    </div>
                    <button type="button" onclick="openHabitModal()" class="btn btn-soft btn-sm">
                        <span class="material-icons-round text-sm">add</span>
                        Ajouter
                    </button>
                </div>
                <div id="habitsContainer" class="space-y-3">
                    <div class="text-center py-8 text-faint">
                        <span class="text-3xl mb-2 block">üéØ</span>
                        <p class="text-sm">Aucune habitude d√©finie</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vue Ma Journ√©e & Mini Calendrier -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 reveal" style="--delay: 0.4s;" id="section-today">
            <!-- Ma Journ√©e -->
            <div class="lg:col-span-2 glass-panel rounded-xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <span class="text-2xl">‚òÄÔ∏è</span>
                        <h3 class="text-sm font-bold tracking-widest text-subtle uppercase">Ma Journ√©e</h3>
                    </div>
                    <span class="text-xs text-muted" id="todayTaskCount">0 t√¢ches prioritaires</span>
                </div>
                <div id="todayTasksContainer" class="space-y-2">
                    <div class="text-center py-8 text-faint">
                        <span class="text-3xl mb-2 block">üåÖ</span>
                        <p class="text-sm">Aucune t√¢che urgente pour aujourd'hui</p>
                    </div>
                </div>
            </div>

            <!-- Mini Calendrier -->
            <div class="glass-panel rounded-xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <span class="text-2xl">üóìÔ∏è</span>
                        <h3 class="text-sm font-bold tracking-widest text-subtle uppercase">Calendrier</h3>
                    </div>
                    <div class="flex items-center gap-1">
                        <button type="button" onclick="changeMonth(-1)" class="action-btn">
                            <span class="material-icons-round text-sm">chevron_left</span>
                        </button>
                        <span id="calendarMonthLabel"
                            class="text-xs font-medium text-subtle min-w-[80px] text-center">Jan
                            2026</span>
                        <button type="button" onclick="changeMonth(1)" class="action-btn">
                            <span class="material-icons-round text-sm">chevron_right</span>
                        </button>
                    </div>
                </div>
                <div id="miniCalendar" class="grid grid-cols-7 gap-1 text-center">
                    <div class="text-xs font-medium text-faint py-1">L</div>
                    <div class="text-xs font-medium text-faint py-1">M</div>
                    <div class="text-xs font-medium text-faint py-1">M</div>
                    <div class="text-xs font-medium text-faint py-1">J</div>
                    <div class="text-xs font-medium text-faint py-1">V</div>
                    <div class="text-xs font-medium text-faint py-1">S</div>
                    <div class="text-xs font-medium text-faint py-1">D</div>
                </div>
                <div id="calendarDays" class="grid grid-cols-7 gap-1 mt-1"></div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 min-h-[500px] reveal" style="--delay: 0.45s;">
            <aside class="glass-panel rounded-xl p-4 lg:col-span-1 h-full">
                <h2 class="text-xs font-bold tracking-widest text-muted uppercase mb-4 px-2">
                    Cat√©gories</h2>
                <nav class="space-y-1">
                    <button type="button"
                        class="category-item active flex items-center justify-between px-3 py-3 rounded-lg text-subtle border-l-4 border-transparent transition-all group"
                        data-category="all">
                        <div class="flex items-center gap-3">
                            <span class="text-lg opacity-80 group-hover:scale-110 transition-transform">‚õ©Ô∏è</span>
                            <span class="font-medium text-sm">Toutes</span>
                        </div>
                        <span class="text-xs font-bold bg-surface-2 px-2 py-0.5 rounded-full text-muted"
                            id="countAll">0</span>
                    </button>
                    <button type="button"
                        class="category-item flex items-center justify-between px-3 py-3 rounded-lg text-subtle border-l-4 border-transparent transition-all group"
                        data-category="easynode">
                        <div class="flex items-center gap-3">
                            <span
                                class="material-icons-round text-info text-lg group-hover:scale-110 transition-transform">rocket_launch</span>
                            <span class="font-medium text-sm">EasyNode</span>
                        </div>
                        <span class="text-xs font-bold bg-surface-2 px-2 py-0.5 rounded-full text-muted"
                            id="countEasynode">0</span>
                    </button>
                    <button type="button"
                        class="category-item flex items-center justify-between px-3 py-3 rounded-lg text-subtle border-l-4 border-transparent transition-all group"
                        data-category="immobilier">
                        <div class="flex items-center gap-3">
                            <span class="text-lg group-hover:scale-110 transition-transform">üèØ</span>
                            <span class="font-medium text-sm">Immobilier</span>
                        </div>
                        <span class="text-xs font-bold bg-surface-2 px-2 py-0.5 rounded-full text-muted"
                            id="countImmobilier">0</span>
                    </button>
                    <button type="button"
                        class="category-item flex items-center justify-between px-3 py-3 rounded-lg text-subtle border-l-4 border-transparent transition-all group"
                        data-category="content">
                        <div class="flex items-center gap-3">
                            <span
                                class="material-icons-round text-accent text-lg group-hover:scale-110 transition-transform">smartphone</span>
                            <span class="font-medium text-sm">Content</span>
                        </div>
                        <span class="text-xs font-bold bg-surface-2 px-2 py-0.5 rounded-full text-muted"
                            id="countContent">0</span>
                    </button>
                    <button type="button"
                        class="category-item flex items-center justify-between px-3 py-3 rounded-lg text-subtle border-l-4 border-transparent transition-all group"
                        data-category="personnel">
                        <div class="flex items-center gap-3">
                            <span class="text-lg group-hover:scale-110 transition-transform">üéã</span>
                            <span class="font-medium text-sm">Personnel</span>
                        </div>
                        <span class="text-xs font-bold bg-surface-2 px-2 py-0.5 rounded-full text-muted"
                            id="countPersonnel">0</span>
                    </button>
                    <button type="button"
                        class="category-item flex items-center justify-between px-3 py-3 rounded-lg text-subtle border-l-4 border-transparent transition-all group"
                        data-category="admin">
                        <div class="flex items-center gap-3">
                            <span
                                class="material-icons-round text-muted text-lg group-hover:scale-110 transition-transform">description</span>
                            <span class="font-medium text-sm">Admin</span>
                        </div>
                        <span class="text-xs font-bold bg-surface-2 px-2 py-0.5 rounded-full text-muted"
                            id="countAdmin">0</span>
                    </button>
                </nav>
                <div class="mt-6 border-t border-subtle pt-4">
                    <h3 class="text-xs font-bold tracking-widest text-muted uppercase mb-3 px-2">
                        Liens utiles</h3>
                    <div class="space-y-2">
                        <a class="flex items-center justify-between px-3 py-2 rounded-lg text-sm text-subtle link-row transition-all"
                            href="#section-stats">Statistiques</a>
                        <a class="flex items-center justify-between px-3 py-2 rounded-lg text-sm text-subtle link-row transition-all"
                            href="#section-progress">Progression</a>
                        <a class="flex items-center justify-between px-3 py-2 rounded-lg text-sm text-subtle link-row transition-all"
                            href="#section-tasks">T√¢ches</a>
                        <a class="flex items-center justify-between px-3 py-2 rounded-lg text-sm text-subtle link-row transition-all"
                            href="#section-add">Ajout rapide</a>
                    </div>
                </div>
            </aside>
            <main
                class="glass-panel rounded-xl lg:col-span-3 flex flex-col border border-subtle relative overflow-hidden"
                id="section-tasks">
                <div class="absolute inset-0 opacity-[0.04] pointer-events-none"
                    style="background-image: radial-gradient(circle, rgba(86, 98, 115, 0.35) 1px, transparent 1px); background-size: 22px 22px;">
                </div>
                <div
                    class="p-6 border-b border-subtle flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 relative z-10">
                    <h2 class="text-xl font-display font-medium text-ink" id="sectionTitle">Toutes
                        les t√¢ches</h2>
                    <div class="flex p-1 bg-surface-2 rounded-lg border border-subtle">
                        <button type="button"
                            class="filter-tab px-4 py-1.5 rounded-md text-xs font-medium transition-all active"
                            data-status="all">Toutes</button>
                        <button type="button"
                            class="filter-tab px-4 py-1.5 rounded-md text-xs font-medium transition-all"
                            data-status="pending">En attente</button>
                        <button type="button"
                            class="filter-tab px-4 py-1.5 rounded-md text-xs font-medium transition-all"
                            data-status="archived">Archives</button>
                    </div>
                </div>
                <div class="p-6 flex-grow relative z-10">
                    <div class="flex gap-2 mb-10" id="section-add">
                        <div class="relative flex-grow">
                            <input class="field field-compact"
                                placeholder="Ajouter rapidement une t√¢che... (Entr√©e pour valider)" type="text"
                                id="quickAddInput" />
                        </div>
                        <button type="button" class="btn btn-primary btn-icon" onclick="quickAdd()">
                            <span class="material-icons-round">add</span>
                        </button>
                    </div>
                    <div class="space-y-3" id="todoList">
                        <div class="flex flex-col items-center justify-center h-64 text-center mt-4">
                            <div class="relative mb-6">
                                <div class="w-32 h-32 rounded-full halo flex items-center justify-center">
                                    <span class="text-6xl drop-shadow-xl animate-pulse">üóª</span>
                                </div>
                                <div class="absolute -top-2 right-0 text-xl animate-bounce"
                                    style="animation-duration: 3s;">üå∏</div>
                                <div class="absolute top-10 -left-4 text-lg animate-bounce"
                                    style="animation-duration: 4s; animation-delay: 1s;">üå∏</div>
                            </div>
                            <h3 class="text-lg font-display font-medium text-subtle mb-1">Aucune t√¢che ici!</h3>
                            <p class="text-sm text-muted max-w-xs mx-auto">
                                L'esprit est clair comme l'eau calme.<br />Profitez de ce moment de s√©r√©nit√©.
                            </p>
                        </div>
                    </div>
                </div>
                <div class="h-1 w-full section-glow"></div>
            </main>
        </div>
    </div>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <h2 class="font-display" id="modalTitle">Nouvelle t√¢che</h2>
            <form id="todoForm">
                <input type="hidden" id="todoId" />
                <div class="form-group">
                    <label class="label" for="todoTitle">Titre</label>
                    <input class="field" type="text" id="todoTitle" required aria-required="true" placeholder="Ex: Finir le script LLM" />
                </div>
                <div class="form-group">
                    <label class="label" for="todoDescription">Description (optionnel)</label>
                    <textarea class="field" id="todoDescription" rows="2"
                        placeholder="D√©tails suppl√©mentaires..."></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="label" for="todoCategory">Cat√©gorie</label>
                        <select class="field" id="todoCategory">
                            <option value="easynode">üöÄ EasyNode</option>
                            <option value="immobilier">üèØ Immobilier</option>
                            <option value="content">üì± Content</option>
                            <option value="personnel">üéã Personnel</option>
                            <option value="admin">üìÑ Admin</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="label" for="todoPriority">Priorit√©</label>
                        <select class="field" id="todoPriority">
                            <option value="normal">üü° Normal</option>
                            <option value="important">üü† Important</option>
                            <option value="urgent">üî¥ Urgent</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="label" for="todoDeadline">Deadline (optionnel)</label>
                    <input class="field" type="datetime-local" id="todoDeadline" />
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Annuler</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Roadmap -->
    <div class="modal-overlay" id="roadmapModalOverlay">
        <div class="modal">
            <h2 class="font-display" id="roadmapModalTitle">Nouvel objectif</h2>
            <form id="roadmapForm">
                <input type="hidden" id="roadmapItemId" />
                <div class="form-group">
                    <label class="label" for="roadmapTitle">Titre</label>
                    <input class="field" type="text" id="roadmapTitle" required aria-required="true"
                        placeholder="Ex: Lancer EasyNode v2.0" />
                </div>
                <div class="form-group">
                    <label class="label" for="roadmapDescription">Description (optionnel)</label>
                    <textarea class="field" id="roadmapDescription" rows="2"
                        placeholder="D√©tails sur cet objectif..."></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="label" for="roadmapType">Type</label>
                        <select class="field" id="roadmapType">
                            <option value="mid_term">üìÖ Mi-terme (3-6 mois)</option>
                            <option value="long_term">üéØ Long-terme (6+ mois)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="label" for="roadmapStatus">Statut</label>
                        <select class="field" id="roadmapStatus">
                            <option value="not_started">‚è≥ Non d√©marr√©</option>
                            <option value="in_progress">üîÑ En cours</option>
                            <option value="completed">‚úÖ Termin√©</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="label" for="roadmapTargetDate">Date cible</label>
                    <input class="field" type="date" id="roadmapTargetDate" />
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeRoadmapModal()">Annuler</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Habit -->
    <div class="modal-overlay" id="habitModalOverlay">
        <div class="modal">
            <h2 class="font-display">Nouvelle habitude</h2>
            <form id="habitForm">
                <div class="form-group">
                    <label class="label" for="habitName">Nom de l'habitude</label>
                    <input class="field" type="text" id="habitName" required placeholder="Ex: M√©ditation 10 min" />
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="label" for="habitEmoji">Emoji</label>
                        <select class="field" id="habitEmoji">
                            <option value="‚úÖ">‚úÖ Check</option>
                            <option value="üßò">üßò M√©ditation</option>
                            <option value="üìö">üìö Lecture</option>
                            <option value="üí™">üí™ Sport</option>
                            <option value="üíß">üíß Eau</option>
                            <option value="ü•ó">ü•ó Alimentation</option>
                            <option value="üí§">üí§ Sommeil</option>
                            <option value="üìù">üìù Journal</option>
                            <option value="üéØ">üéØ Objectif</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="label" for="habitColor">Couleur</label>
                        <select class="field" id="habitColor">
                            <option value="#10b981">üü¢ Vert</option>
                            <option value="#3b82f6">üîµ Bleu</option>
                            <option value="#8b5cf6">üü£ Violet</option>
                            <option value="#f59e0b">üü† Orange</option>
                            <option value="#ef4444">üî¥ Rouge</option>
                            <option value="#ec4899">ü©∑ Rose</option>
                        </select>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeHabitModal()">Annuler</button>
                    <button type="submit" class="btn btn-success">Cr√©er</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Theme Switcher -->
    <script src="/js/theme-switcher.js"></script>

    <script>
        // State
        let todos = [];
        let archivedTodos = [];
        let roadmapItems = [];
        let currentRoadmapType = 'mid_term';
        let currentFilter = { status: 'all', category: 'all' };

        // API Base URL
        const API_URL = '';

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            updateDate();
            loadTodos();
            loadStats();
            loadDailyContent();
            loadRoadmap();
            setupEventListeners();
        });

        function updateDate() {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('currentDate').textContent =
                new Date().toLocaleDateString('fr-FR', options);
        }

        function setupEventListeners() {
            // Category filters
            document.querySelectorAll('.category-item').forEach(item => {
                item.addEventListener('click', () => {
                    document.querySelectorAll('.category-item').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    currentFilter.category = item.dataset.category;
                    updateSectionTitle();
                    renderTodos();
                });
            });

            // Status filters
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const wasArchived = currentFilter.status === 'archived';
                    const isArchived = tab.dataset.status === 'archived';

                    document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentFilter.status = tab.dataset.status;

                    if (isArchived) {
                        loadArchivedTodos();
                    } else if (wasArchived) {
                        loadTodos();
                    } else {
                        renderTodos();
                    }
                });
            });

            // Roadmap type filters
            document.querySelectorAll('.roadmap-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.roadmap-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentRoadmapType = tab.dataset.type;
                    renderRoadmap();
                });
            });

            // Quick add on Enter
            document.getElementById('quickAddInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') quickAdd();
            });

            // Form submit
            document.getElementById('todoForm').addEventListener('submit', handleFormSubmit);

            // Roadmap form submit
            document.getElementById('roadmapForm').addEventListener('submit', handleRoadmapFormSubmit);

            // Close modal on overlay click
            document.getElementById('modalOverlay').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) closeModal();
            });

            // Close roadmap modal on overlay click
            document.getElementById('roadmapModalOverlay').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) closeRoadmapModal();
            });
        }

        function updateSectionTitle() {
            const titles = {
                'all': 'Toutes les t√¢ches',
                'easynode': 'üöÄ EasyNode',
                'immobilier': 'üèØ Immobilier',
                'content': 'üì± Content',
                'personnel': 'üéã Personnel',
                'admin': 'üìÑ Admin'
            };
            document.getElementById('sectionTitle').textContent = titles[currentFilter.category] || 'Toutes les t√¢ches';
        }

        // API Functions
        async function loadTodos() {
            try {
                const response = await fetch(`${API_URL}/api/todos`);
                todos = await response.json();
                renderTodos();
                updateCategoryCounts();
            } catch (error) {
                console.error('Error loading todos:', error);
            }
        }

        async function loadArchivedTodos() {
            try {
                const response = await fetch(`${API_URL}/api/todos/archived`);
                archivedTodos = await response.json();
                renderTodos();
            } catch (error) {
                console.error('Error loading archived todos:', error);
            }
        }

        async function loadStats() {
            try {
                const response = await fetch(`${API_URL}/api/stats`);
                const stats = await response.json();

                document.getElementById('statTotal').textContent = stats.total;
                document.getElementById('statPending').textContent = stats.pending;
                document.getElementById('statCompleted').textContent = stats.completed;
                document.getElementById('statOverdue').textContent = stats.overdue;
                document.getElementById('statToday').textContent = stats.today_completed;
                document.getElementById('progressPercent').textContent = `${stats.completion_rate}%`;
                document.getElementById('progressFill').style.width = `${stats.completion_rate}%`;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function createTodo(data) {
            try {
                const response = await fetch(`${API_URL}/api/todos`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const todo = await response.json();
                todos.unshift(todo);
                renderTodos();
                loadStats();
                updateCategoryCounts();
            } catch (error) {
                console.error('Error creating todo:', error);
            }
        }

        async function updateTodo(id, data) {
            try {
                const response = await fetch(`${API_URL}/api/todos/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const updated = await response.json();
                if (updated.archived === 1) {
                    todos = todos.filter(t => t.id !== id);
                    const archivedIndex = archivedTodos.findIndex(t => t.id === id);
                    if (archivedIndex !== -1) {
                        archivedTodos[archivedIndex] = updated;
                    } else {
                        archivedTodos.unshift(updated);
                    }
                } else {
                    archivedTodos = archivedTodos.filter(t => t.id !== id);
                    const index = todos.findIndex(t => t.id === id);
                    if (index !== -1) {
                        todos[index] = updated;
                    } else {
                        todos.unshift(updated);
                    }
                }
                renderTodos();
                loadStats();
                updateCategoryCounts();
            } catch (error) {
                console.error('Error updating todo:', error);
            }
        }

        function formatDescription(description) {
            if (!description) return '';

            // Convert markdown-style formatting to HTML with emoji highlighting
            return description
                .replace(/‚è±Ô∏è/g, '<strong>‚è±Ô∏è</strong>')
                .replace(/üß≠/g, '<strong>üß≠</strong>')
                .replace(/(\d+)\./g, '<strong>$1.</strong>');
        }

        async function deleteTodo(id) {
            if (!confirm('Supprimer cette t√¢che ?')) return;

            try {
                await fetch(`${API_URL}/api/todos/${id}`, { method: 'DELETE' });
                todos = todos.filter(t => t.id !== id);
                archivedTodos = archivedTodos.filter(t => t.id !== id);
                renderTodos();
                loadStats();
                updateCategoryCounts();
            } catch (error) {
                console.error('Error deleting todo:', error);
            }
        }

        async function restoreTodo(id) {
            if (!confirm('Restaurer cette t√¢che ?')) return;
            await updateTodo(id, { archived: 0, status: 'pending' });
            loadTodos();
        }

        async function sendDailySummary() {
            try {
                await fetch(`${API_URL}/api/daily-summary`, { method: 'POST' });
                alert('üìä R√©sum√© envoy√© sur Telegram!');
            } catch (error) {
                console.error('Error sending summary:', error);
            }
        }

        // Render Functions
        function renderTodos() {
            const list = document.getElementById('todoList');
            const source = currentFilter.status === 'archived' ? archivedTodos : todos;
            let filtered = [...source];

            // Apply filters
            if (currentFilter.status === 'archived') {
                filtered = filtered.filter(t => t.archived === 1);
            } else {
                // Default view: not archived
                filtered = filtered.filter(t => !t.archived);

                if (currentFilter.status !== 'all') {
                    filtered = filtered.filter(t => t.status === currentFilter.status);
                }
            }

            if (currentFilter.category !== 'all') {
                filtered = filtered.filter(t => t.category === currentFilter.category);
            }

            if (filtered.length === 0) {
                list.innerHTML = `
                <div class="flex flex-col items-center justify-center h-64 text-center mt-4">
                    <div class="relative mb-6">
                        <div class="w-32 h-32 rounded-full halo flex items-center justify-center">
                            <span class="text-6xl drop-shadow-xl animate-pulse">üóª</span>
                        </div>
                        <div class="absolute -top-2 right-0 text-xl animate-bounce" style="animation-duration: 3s;">üå∏</div>
                        <div class="absolute top-10 -left-4 text-lg animate-bounce" style="animation-duration: 4s; animation-delay: 1s;">üå∏</div>
                    </div>
                    <h3 class="text-lg font-display font-medium text-subtle mb-1">Aucune t√¢che ici!</h3>
                    <p class="text-sm text-muted max-w-xs mx-auto">
                        L'esprit est clair comme l'eau calme.<br/>Profitez de ce moment de s√©r√©nit√©.
                    </p>
                </div>
            `;
                return;
            }

            list.innerHTML = filtered.map(todo => {
                const priorityClass = `priority-${todo.priority}`;
                const isArchived = todo.archived === 1;
                const isCompleted = todo.status === 'completed' && !isArchived;
                const categoryEmoji = {
                    'easynode': 'üöÄ',
                    'immobilier': 'üèØ',
                    'content': 'üì±',
                    'personnel': 'üéã',
                    'admin': 'üìÑ'
                }[todo.category] || 'üìã';

                let deadlineStr = '';
                if (todo.deadline) {
                    const deadline = new Date(todo.deadline);
                    deadlineStr = deadline.toLocaleDateString('fr-FR', {
                        day: 'numeric',
                        month: 'short',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }

                const stateClass = isArchived ? 'archived' : (isCompleted ? 'completed' : '');
                const checkboxClass = isCompleted ? 'checked' : '';
                return `
                <div class="todo-item ${stateClass}" data-id="${todo.id}">
                    <div class="todo-checkbox ${checkboxClass}" onclick="toggleTodo(${todo.id}, '${todo.status}', ${isArchived})"></div>
                    <div class="todo-content">
                        <div class="todo-title">${todo.title}</div>
                        ${todo.description ? `
                            <div class="todo-description">${formatDescription(todo.description)}</div>
                        ` : ''}
                        <div class="todo-meta">
                            <span>${categoryEmoji} ${todo.category}</span>
                            ${deadlineStr ? `<span>‚è≥ ${deadlineStr}</span>` : ''}
                            ${isArchived ? `<span>üì¶ Archiv√©e</span>` : ''}
                        </div>
                    </div>
                    <span class="priority-badge ${priorityClass}">${todo.priority}</span>
                    <div class="todo-actions">
                        ${isArchived ? `
                        <button class="action-btn" onclick="restoreTodo(${todo.id})" title="Restaurer">
                            <span class="material-icons-round text-sm">restart_alt</span>
                        </button>
                        ` : ''}
                        <button class="action-btn" onclick="editTodo(${todo.id})">‚úèÔ∏è</button>
                        <button class="action-btn delete" onclick="deleteTodo(${todo.id})">üóëÔ∏è</button>
                    </div>
                </div>
            `;
            }).join('');
        }

        function updateCategoryCounts() {
            const counts = {
                all: todos.filter(t => t.status === 'pending').length,
                easynode: todos.filter(t => t.category === 'easynode' && t.status === 'pending').length,
                immobilier: todos.filter(t => t.category === 'immobilier' && t.status === 'pending').length,
                content: todos.filter(t => t.category === 'content' && t.status === 'pending').length,
                personnel: todos.filter(t => t.category === 'personnel' && t.status === 'pending').length,
                admin: todos.filter(t => t.category === 'admin' && t.status === 'pending').length
            };

            document.getElementById('countAll').textContent = counts.all;
            document.getElementById('countEasynode').textContent = counts.easynode;
            document.getElementById('countImmobilier').textContent = counts.immobilier;
            document.getElementById('countContent').textContent = counts.content;
            document.getElementById('countPersonnel').textContent = counts.personnel;
            document.getElementById('countAdmin').textContent = counts.admin;
        }

        // Actions
        function toggleTodo(id, currentStatus, isArchived) {
            if (isArchived) return;
            const newStatus = currentStatus === 'completed' ? 'pending' : 'completed';
            if (newStatus === 'completed') {
                todos = todos.map(t => t.id === id ? { ...t, status: 'completed', archived: 1 } : t);
                renderTodos();
                updateCategoryCounts();
            }
            updateTodo(id, { status: newStatus });
        }

        function quickAdd() {
            const input = document.getElementById('quickAddInput');
            const title = input.value.trim();
            if (!title) return;

            createTodo({
                title,
                category: currentFilter.category !== 'all' ? currentFilter.category : 'easynode',
                priority: 'normal'
            });
            input.value = '';
        }

        function openModal(todoId = null) {
            const modal = document.getElementById('modalOverlay');
            const form = document.getElementById('todoForm');
            const title = document.getElementById('modalTitle');

            form.reset();
            document.getElementById('todoId').value = '';

            if (todoId) {
                const todo = todos.find(t => t.id === todoId);
                if (todo) {
                    title.textContent = 'Modifier la t√¢che';
                    document.getElementById('todoId').value = todo.id;
                    document.getElementById('todoTitle').value = todo.title;
                    document.getElementById('todoDescription').value = todo.description || '';
                    document.getElementById('todoCategory').value = todo.category;
                    document.getElementById('todoPriority').value = todo.priority;
                    if (todo.deadline) {
                        try {
                            // Ensure deadline is in correct format for datetime-local (YYYY-MM-DDThh:mm)
                            document.getElementById('todoDeadline').value = todo.deadline.slice(0, 16);
                        } catch (e) {
                            console.error("Date error", e);
                        }
                    }
                }
            } else {
                title.textContent = 'Nouvelle t√¢che';
            }

            modal.classList.add('active');
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('active');
        }

        function editTodo(id) {
            openModal(id);
        }

        async function handleFormSubmit(e) {
            e.preventDefault();

            const id = document.getElementById('todoId').value;
            const data = {
                title: document.getElementById('todoTitle').value,
                description: document.getElementById('todoDescription').value,
                category: document.getElementById('todoCategory').value,
                priority: document.getElementById('todoPriority').value,
                deadline: document.getElementById('todoDeadline').value || null
            };

            if (id) {
                await updateTodo(parseInt(id), data);
            } else {
                await createTodo(data);
            }

            closeModal();
        }

        // ============== DAILY CONTENT ==============

        async function loadDailyContent() {
            try {
                const response = await fetch(`${API_URL}/api/daily-content`);
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('dailyQuote').textContent = `"${data.quote}"`;
                    document.getElementById('dailyQuoteAuthor').textContent = `‚Äî ${data.quote_author || 'Inconnu'}`;
                    document.getElementById('dailyFunFact').textContent = data.fun_fact;
                }
            } catch (error) {
                console.error('Error loading daily content:', error);
                document.getElementById('dailyQuote').textContent = '"Chaque jour est une nouvelle opportunit√©."';
                document.getElementById('dailyQuoteAuthor').textContent = '‚Äî Proverbe';
                document.getElementById('dailyFunFact').textContent = 'Le premier programme informatique a √©t√© √©crit par Ada Lovelace en 1843.';
            }
        }

        async function refreshDailyContent() {
            try {
                document.getElementById('dailyQuote').textContent = '"G√©n√©ration en cours..."';
                document.getElementById('dailyFunFact').textContent = 'G√©n√©ration en cours...';

                const response = await fetch(`${API_URL}/api/daily-content/generate`, { method: 'POST' });
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('dailyQuote').textContent = `"${data.quote}"`;
                    document.getElementById('dailyQuoteAuthor').textContent = `‚Äî ${data.quote_author || 'Inconnu'}`;
                    document.getElementById('dailyFunFact').textContent = data.fun_fact;
                }
            } catch (error) {
                console.error('Error refreshing daily content:', error);
            }
        }

        // ============== ROADMAP ==============

        async function loadRoadmap() {
            try {
                const response = await fetch(`${API_URL}/api/roadmap`);
                roadmapItems = await response.json();
                renderRoadmap();
            } catch (error) {
                console.error('Error loading roadmap:', error);
            }
        }

        function renderRoadmap() {
            const container = document.getElementById('roadmapContent');
            const filtered = roadmapItems.filter(item => item.type === currentRoadmapType);

            if (filtered.length === 0) {
                const typeLabel = currentRoadmapType === 'mid_term' ? 'mi-terme' : 'long-terme';
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-40 text-center">
                        <span class="text-4xl mb-3 animate-pulse">üéØ</span>
                        <p class="text-sm text-muted">Aucun objectif ${typeLabel} d√©fini. Ajoutez votre premier objectif!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">${filtered.map(item => {
                const statusEmoji = {
                    'not_started': '‚è≥',
                    'in_progress': 'üîÑ',
                    'completed': '‚úÖ'
                }[item.status] || 'üìã';

                const statusClass = {
                    'not_started': 'status-pill status-idle',
                    'in_progress': 'status-pill status-progress',
                    'completed': 'status-pill status-completed'
                }[item.status] || 'status-pill status-idle';

                const targetDate = item.target_date ? new Date(item.target_date).toLocaleDateString('fr-FR', { month: 'short', year: 'numeric' }) : 'Non d√©finie';

                return `
                    <div class="glass-panel p-4 rounded-xl border border-subtle card-hover group ${item.status === 'completed' ? 'opacity-70' : ''}">
                        <div class="flex items-start justify-between mb-2">
                            <span class="text-2xl">${item.type === 'mid_term' ? 'üìÖ' : 'üéØ'}</span>
                            <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button class="action-btn" onclick="editRoadmapItem(${item.id})">‚úèÔ∏è</button>
                                <button class="action-btn delete" onclick="deleteRoadmapItem(${item.id})">üóëÔ∏è</button>
                            </div>
                        </div>
                        <h4 class="font-medium text-ink mb-1 ${item.status === 'completed' ? 'line-through' : ''}">${item.title}</h4>
                        ${item.description ? `<p class="text-xs text-muted mb-3">${item.description}</p>` : ''}
                        <div class="flex items-center justify-between mt-3">
                            <span class="text-xs ${statusClass} px-2 py-1 rounded-full">${statusEmoji} ${item.status.replace('_', ' ')}</span>
                            <span class="text-xs text-muted">üóìÔ∏è ${targetDate}</span>
                        </div>
                    </div>
                `;
            }).join('')}</div>`;
        }

        function openRoadmapModal(itemId = null) {
            const modal = document.getElementById('roadmapModalOverlay');
            const form = document.getElementById('roadmapForm');
            const title = document.getElementById('roadmapModalTitle');

            form.reset();
            document.getElementById('roadmapItemId').value = '';
            document.getElementById('roadmapType').value = currentRoadmapType;

            if (itemId) {
                const item = roadmapItems.find(i => i.id === itemId);
                if (item) {
                    title.textContent = 'Modifier l\'objectif';
                    document.getElementById('roadmapItemId').value = item.id;
                    document.getElementById('roadmapTitle').value = item.title;
                    document.getElementById('roadmapDescription').value = item.description || '';
                    document.getElementById('roadmapType').value = item.type;
                    document.getElementById('roadmapStatus').value = item.status;
                    if (item.target_date) {
                        document.getElementById('roadmapTargetDate').value = item.target_date;
                    }
                }
            } else {
                title.textContent = 'Nouvel objectif';
            }

            modal.classList.add('active');
        }

        function closeRoadmapModal() {
            document.getElementById('roadmapModalOverlay').classList.remove('active');
        }

        function editRoadmapItem(id) {
            openRoadmapModal(id);
        }

        async function deleteRoadmapItem(id) {
            if (!confirm('Supprimer cet objectif ?')) return;

            try {
                await fetch(`${API_URL}/api/roadmap/${id}`, { method: 'DELETE' });
                roadmapItems = roadmapItems.filter(i => i.id !== id);
                renderRoadmap();
            } catch (error) {
                console.error('Error deleting roadmap item:', error);
            }
        }

        async function handleRoadmapFormSubmit(e) {
            e.preventDefault();
            console.log("Roadmap form submitted");

            // R√©cup√©rer les donn√©es
            const id = document.getElementById('roadmapItemId').value;
            const title = document.getElementById('roadmapTitle').value;
            const description = document.getElementById('roadmapDescription').value;
            const type = document.getElementById('roadmapType').value;
            const status = document.getElementById('roadmapStatus').value;
            const targetDate = document.getElementById('roadmapTargetDate').value;

            console.log("Data:", { id, title, description, type, status, targetDate });

            // Validation basique
            if (!title) {
                alert("Le titre est obligatoire");
                return;
            }

            const data = {
                title: title,
                description: description,
                type: type,
                status: status,
                target_date: targetDate || null
            };

            try {
                let response;
                if (id) {
                    console.log("Updating item", id);
                    response = await fetch(`${API_URL}/api/roadmap/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                } else {
                    console.log("Creating new item");
                    response = await fetch(`${API_URL}/api/roadmap`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                }

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Erreur API: ${response.status} ${errorText}`);
                }

                const result = await response.json();
                console.log("Success:", result);

                if (id) {
                    const index = roadmapItems.findIndex(i => i.id === parseInt(id));
                    if (index !== -1) roadmapItems[index] = result;
                } else {
                    roadmapItems.unshift(result);
                }

                renderRoadmap();
                closeRoadmapModal();
                // Feedback visuel
                const btn = document.querySelector('#roadmapForm button[type="submit"]');
                const originalText = btn.textContent;
                btn.textContent = "Enregistr√© !";
                setTimeout(() => btn.textContent = originalText, 2000);

            } catch (error) {
                console.error('Error saving roadmap item:', error);
                alert(`Erreur lors de l'enregistrement: ${error.message}`);
            }
        }

        // ==========================================
        // Nouvelles fonctionnalit√©s JS
        // ==========================================

        // -- Analytics & Chart.js --
        let productivityChart = null;

        async function loadAnalytics() {
            try {
                const response = await fetch(`${API_URL}/api/analytics?days=7`);
                const data = await response.json();

                // Update stats UI
                document.getElementById('streakBadge').textContent = `üî• ${data.current_streak} jours`;
                if (data.best_day) {
                    const bestDate = new Date(data.best_day.day).toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric' });
                    document.getElementById('bestDayLabel').textContent = `${bestDate} (${data.best_day.count})`;
                }

                // Render Chart
                renderChart(data.daily_stats);

                // Calculate weekly total
                const weeklyTotal = data.daily_stats.reduce((acc, curr) => acc + curr.completed, 0);
                document.getElementById('weeklyTotal').textContent = weeklyTotal;

            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        function renderChart(stats) {
            const ctx = document.getElementById('productivityChart').getContext('2d');
            const styles = getComputedStyle(document.documentElement);
            const accent = styles.getPropertyValue('--accent').trim() || '#0F7C7F';
            const accentWarm = styles.getPropertyValue('--accent-warm').trim() || '#C97A2D';
            const tooltipBg = styles.getPropertyValue('--bg-surface').trim() || '#141A22';
            const tooltipTitle = styles.getPropertyValue('--text-primary').trim() || '#E6EDF3';
            const tooltipBody = styles.getPropertyValue('--text-secondary').trim() || '#B9C2CD';
            const gridColor = styles.getPropertyValue('--border').trim() || 'rgba(148, 163, 184, 0.1)';
            const tickColor = styles.getPropertyValue('--text-muted').trim() || '#97A3B2';

            // Prepare data
            const labels = stats.map(s => new Date(s.date).toLocaleDateString('fr-FR', { weekday: 'short' }));
            const completedData = stats.map(s => s.completed);
            const createdData = stats.map(s => s.created);

            if (productivityChart) {
                productivityChart.destroy();
            }

            productivityChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Compl√©t√©es',
                            data: completedData,
                            backgroundColor: accent,
                            borderRadius: 4,
                            barThickness: 12
                        },
                        {
                            label: 'Cr√©√©es',
                            data: createdData,
                            backgroundColor: accentWarm,
                            borderRadius: 4,
                            barThickness: 12,
                            hidden: true // hide by default to keep clean
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: tooltipBg,
                            titleColor: tooltipTitle,
                            bodyColor: tooltipBody,
                            padding: 10,
                            cornerRadius: 8,
                            displayColors: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: gridColor,
                                drawBorder: false
                            },
                            ticks: { display: false }
                        },
                        x: {
                            grid: { display: false },
                            ticks: {
                                color: tickColor,
                                font: { size: 10 }
                            }
                        }
                    }
                }
            });
        }

        // -- Habitudes --
        let habits = [];

        async function loadHabits() {
            try {
                const response = await fetch(`${API_URL}/api/habits`);
                habits = await response.json();
                renderHabits();
            } catch (error) {
                console.error('Error loading habits:', error);
            }
        }

        function renderHabits() {
            const container = document.getElementById('habitsContainer');
            if (habits.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-6 text-faint">
                        <span class="text-3xl mb-2 block">üéØ</span>
                        <p class="text-xs">Aucune habitude d√©finie</p>
                    </div>`;
                return;
            }

            container.innerHTML = habits.map(habit => {
                const isDone = habit.today_completed === 1;
                return `
                <div class="flex items-center justify-between p-3 habit-card card-hover group">
                    <div class="flex items-center gap-3">
                        <span class="text-xl bg-surface p-1.5 rounded-lg shadow-sm">${habit.emoji}</span>
                        <div>
                            <div class="font-medium text-sm text-ink">${habit.name}</div>
                            <div class="text-xs text-faint flex items-center gap-1">
                                <span class="material-icons-round text-[10px] text-warning">local_fire_department</span>
                                ${habit.streak} jours
                            </div>
                        </div>
                    </div>
                    <button onclick="toggleHabit(${habit.id})" class="habit-toggle ${isDone ? 'is-done' : ''}">
                        <span class="material-icons-round text-lg">check</span>
                    </button>
                    <button onclick="deleteHabit(${habit.id})" class="action-btn opacity-0 group-hover:opacity-100 transition-opacity ml-2">
                        <span class="material-icons-round text-sm">close</span>
                    </button>
                </div>`;
            }).join('');
        }

        async function toggleHabit(id) {
            try {
                await fetch(`${API_URL}/api/habits/${id}/check`, { method: 'PUT' });
                // Optimistic UI update
                const habit = habits.find(h => h.id === id);
                if (habit) {
                    habit.today_completed = habit.today_completed ? 0 : 1;
                    if (habit.today_completed) habit.streak += 1;
                    else habit.streak = Math.max(0, habit.streak - 1);
                    renderHabits();
                }
                loadHabits(); // Reload for accurate data
            } catch (error) {
                console.error('Error toggling habit:', error);
            }
        }

        async function deleteHabit(id) {
            if (!confirm('Arr√™ter de suivre cette habitude ?')) return;
            try {
                await fetch(`${API_URL}/api/habits/${id}`, { method: 'DELETE' });
                habits = habits.filter(h => h.id !== id);
                renderHabits();
            } catch (error) {
                console.error('Error deleting habit:', error);
            }
        }

        // Habit Modal
        function openHabitModal() { document.getElementById('habitModalOverlay').classList.add('active'); }
        function closeHabitModal() { document.getElementById('habitModalOverlay').classList.remove('active'); }

        document.getElementById('habitForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                name: document.getElementById('habitName').value,
                emoji: document.getElementById('habitEmoji').value,
                color: document.getElementById('habitColor').value
            };
            try {
                await fetch(`${API_URL}/api/habits`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                closeHabitModal();
                loadHabits();
                e.target.reset();
            } catch (error) {
                console.error('Error creating habit:', error);
            }
        });

        document.getElementById('habitModalOverlay').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeHabitModal();
        });


        // -- Ma Journ√©e --
        async function loadTodayTasks() {
            try {
                const response = await fetch(`${API_URL}/api/todos/today`);
                const tasks = await response.json();
                renderTodayTasks(tasks);
                document.getElementById('todayTaskCount').textContent = `${tasks.length} t√¢ches prioritaires`;
            } catch (error) {
                console.error('Error loading today tasks:', error);
            }
        }

        function renderTodayTasks(tasks) {
            const container = document.getElementById('todayTasksContainer');
            if (tasks.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-6 text-faint">
                        <span class="text-3xl mb-2 block">üåÖ</span>
                        <p class="text-sm">Rien d'urgent pour aujourd'hui</p>
                    </div>`;
                return;
            }

            container.innerHTML = tasks.map(todo => {
                const priorityClass = `priority-${todo.priority}`;
                const time = todo.deadline ? new Date(todo.deadline).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }) : '';
                return `
                <div class="flex items-center gap-3 p-3 rounded-lg border border-subtle bg-surface-2 card-hover">
                    <div class="todo-checkbox" onclick="toggleTodo(${todo.id}, '${todo.status}')"></div>
                    <div class="flex-1">
                        <div class="text-sm font-medium text-ink">${todo.title}</div>
                        <div class="text-xs text-muted flex items-center gap-2 mt-0.5">
                            <span class="${priorityClass} px-1.5 py-0.5 rounded text-[10px] uppercase font-bold tracking-wider">${todo.priority}</span>
                            ${time ? `<span class="flex items-center gap-1"><span class="material-icons-round text-[10px]">schedule</span> ${time}</span>` : ''}
                        </div>
                    </div>
                </div>`;
            }).join('');
        }


        // -- Mini Calendrier --
        let currentCalDate = new Date();

        async function loadCalendar() {
            const year = currentCalDate.getFullYear();
            const month = currentCalDate.getMonth() + 1;

            // Update Label
            const monthName = currentCalDate.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
            document.getElementById('calendarMonthLabel').textContent = monthName.charAt(0).toUpperCase() + monthName.slice(1);

            try {
                const response = await fetch(`${API_URL}/api/calendar?year=${year}&month=${month}`);
                const data = await response.json();
                renderMiniCalendar(data);
            } catch (error) {
                console.error('Error loading calendar:', error);
            }
        }

        function renderMiniCalendar(data) {
            const container = document.getElementById('calendarDays');
            container.innerHTML = '';

            const firstDay = new Date(data.year, data.month - 1, 1).getDay(); // 0 = Dimanche
            const daysInMonth = new Date(data.year, data.month, 0).getDate();

            // Adjust for Monday start (Monday = 1, Sunday = 7)
            let startOffset = firstDay === 0 ? 6 : firstDay - 1;

            // Empty slots
            for (let i = 0; i < startOffset; i++) {
                container.innerHTML += `<div></div>`;
            }

            // Days
            for (let day = 1; day <= daysInMonth; day++) {
                const dateKey = `${data.year}-${String(data.month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const hasTask = data.tasks_by_day[dateKey];
                const isToday = new Date().toDateString() === new Date(data.year, data.month - 1, day).toDateString();

                const taskIndicator = hasTask ? `<div class="calendar-dot"></div>` : '';
                const todayClass = isToday ? 'calendar-day today' : 'calendar-day';

                container.innerHTML += `
                    <div class="${todayClass}">
                        <span class="text-xs">${day}</span>
                        ${!isToday ? taskIndicator : ''}
                    </div>
                `;
            }
        }

        function changeMonth(delta) {
            currentCalDate.setMonth(currentCalDate.getMonth() + delta);
            loadCalendar();
        }


        // Initialisation globale
        // On modifie l'initialisation existante ou on ajoute les appels
        const originalInit = window.onload; // Small hack if needed, but safe to just add listener
        document.addEventListener('DOMContentLoaded', () => {
            // Ces fonctions viennent en plus de celles d√©j√† pr√©sentes
            loadAnalytics();
            loadHabits();
            loadTodayTasks();
            loadCalendar();
        });

        // Hook dans les updates existants pour rafraichir les nouveaux widgets
        const originalCreateTodo = createTodo;
        createTodo = async function (data) {
            await originalCreateTodo(data);
            loadAnalytics();
            loadTodayTasks();
            loadCalendar();
        };

        const originalToggleTodo = window.toggleTodo; // Assuming it's global or attached
        // Note: index.html has inline onclick="toggleTodo...", so we need to ensure this hook works.
        // Actually the original toggleTodo isn't shown in the snippets but implied.
        // Let's assume we need to refresh stats when tasks change.

    </script>
</body>

</html>